---
title: "Семинар №14"
author: "Красовицкий Андрей, Грачёв Владислав"
date: "12 декабря 2016 г"
output:
  word_document: default
  pdf_document:
    keep_tex: yes
  html_document: default
language: ru-RU
---

# Конспект семинара 14. Гетеро или гомо? {hetero_or_homo}

Для начала стоит определить, что такое __Гетероскедастичность__!!!

_Определение, украденное с Википедии_: Гетероскедастичность (англ. heteroscedasticity) — понятие, используемое в прикладной статистике (чаще всего — в эконометрике), означающее неоднородность наблюдений, выражающуюся в неодинаковой (непостоянной) дисперсии случайной ошибки регрессионной (эконометрической) модели. Гетероскедастичность противоположна гомоскедастичности, означающей однородность наблюдений, то есть постоянство дисперсии случайных ошибок модели.

Другими словами:
$$Var(u_i|X) \neq {const} = f(x_i)$$

### Какие последствия отсюда вытекают?

__Хорошие последствия:__

- $\widehat{\beta}$ - несмещенно 

- $\widehat{\beta}$ - состоятельно

__Плохие последствия:__

- $\widehat{\beta}$ - неэффективно

$$\left(\frac{\widehat{\beta}_i-\beta_i}{se(\widehat{\beta}_i)}\right)
\nrightarrow N(0, 1)$$

__(!)__ Для борьбы с гетероскедастичностью нужно знать структуру самой гетероскедастичности!

Например, на прошлом семинаре была доказано, что:

$$\left(\frac{\widehat{\beta}_i-\beta_i}{se_{hco} (\widehat{\beta}_i)}\right)
\rightarrow N(0, 1)$$

В данном случае индекс _hco_ означает _heteroscedasticity consistent_, т.е. гетероскедастично устойчиво. Говоря языком программистов и статистов, берутся робастные стандартные ошибки.

$se_{hco} (\widehat{\beta}_i)$ добывается с диоганали матрицы $\widehat{var}(\widehat{\beta}|X)=(X'X)^{-1}\widehat{\Omega}X(X'X)$

\[
\widehat{\Omega}_{hco}=\begin{pmatrix}
\widehat{u}^2_1 & \ldots & \ldots & 0 \\
0 & \widehat{u}^2_2 & \ldots & \ldots \\
\ldots & \ldots & \ldots & \ldots \\
0 & \ldots & \ldots & \widehat{u}^2_n \\
\end{pmatrix}
\]


### Обнаружение гетероскедастичности

1. __Графическое__

Для наглядного примера возьмём датасет про зависимость стоимости квартир от площади.

![График с явной гетероскедастичностью](images/14_hetero.png)

На данном графике красными линиями обозначены примерные отклонения. Отчетливо видно, что в зависимости от значения площади наблюдается разный разброс в ценах квартир. 

Как правило, причиной возникновения гетероскедастичности является размер объекта.

Например:

- размер семьи влияет на диспресию расходов и доходов 
- размер компании влияет на разброс в доходах сотрудников 
- можно придумать ещё много примеров 

2. _Более утончённое графическое_

Если $Var(u_i|X) = \sigma^2$, то $var(\widehat{u}|X) = (I-H)\sigma^2$. Можно заметить, что если __u__ - гомоскедастично, тогда дисперсии всё равно будут разными ($H=X(X'X)^{-1}X'$). 
То есть $Var(\widehat{u}_i|X)=g_i(X)$

_Что же делать?_

Можно отнормировать остатки!

\[
\widehat{u}^{*}_i=\frac{\widehat{u}^*_i}{\sqrt{1-h_{ii}}}
\]

В данном случае $h_{ii}$ это диагональные элементы матрицы __H__

$$\Rightarrow Var(\widehat{u}^*_i)=\sigma^2$$

Следовательно, в случае в случае гомоскедастичности дисперсия будет постоянной величиной.

В случае же гетероскедастичности график будет выглядить следующим образом (возьмём тот же пример с квартирами):

```{r, "grafick", echo=FALSE, results='hide',message=FALSE}
library("ggplot2")
h <- read.table("https://raw.githubusercontent.com/bdemeshev/em301/master/datasets/flats_moscow.txt",header=TRUE)
X <- matrix(h$totsp)
X <- cbind(rep(1, nrow(X)), X)
Y <- matrix(h$price)
H <- X %*% solve(t(X)%*%X) %*% t(X)
B_pred <- solve(t(X)%*%X) %*% t(X) %*% Y
Y_pred <- X %*% B_pred
U <- Y - Y_pred
U_star <- U/sqrt(rep(1, nrow(H))-diag(H))
U_star <- abs(U_star)
qplot(h$totsp, U_star, alpha = 0.5) + xlab("Общая площадь") +
  ylab("модуль отклонения")
```

В даном случае строится график зависимости $\widehat{u}^{*2}_i$ или $|{\widehat{u}^*_i}|$ от переменной, преположительно виновной в гетероскедастичности. 

3. _Тесты_

__Как делаются большинство тестов:__

_Шаг №1_

Оценим $y_i = \beta_i+\beta_2x_i+u_i$

Отсюда получим $\widehat{u}_i$

_Шаг №1.5_

$$\widehat{u}^*_i=\frac{\widehat{u}_i}{\sqrt{1-h_{ii}}}$$
_Шаг 2: вспомогательная регрессия_

Строим регрессию «размера остатка», это может быть $\widehat{u}^2_i$, $|\widehat{u}_i|$ или  $\log\widehat{u}_i$ на объясняющие переменные:

\[
\text{размер остатка}_i = \gamma_1+\gamma_2z_i+\gamma_3w_i + \ldots+ \gamma_h r_i + \nu_i
\]

*
__В случае__ $\hat u^2_i$ __используется тест Бройша — Пагана (про него можно подробно почитать на википедии)__


Далее проверем гипотезу о гетероскедастичности:

\[
H_0:\gamma_1=\gamma_2=...=\gamma_h=0, \text{гомоскедастичность}
\]

$H_a$: хотя бы один из коэффициентов $\gamma_1$, $\gamma_2$, \ldots, $\gamma_h$ отличен от нуля.

Далее для проверки можно взять одну из тестовых статистик:

_F-test_

\[
F_{test}=\frac{(RSS_R-RSS_{UR})/q}{RSS_{UR}/n-k_{UR}}
\]

где 

- $RSS_{R}$ - это сумма квадратов остатков модели с ограничениями
- $RSS_{UR}$ - это сумма квадратов остатков модели без ограничений
- $q$ - это количество ограничений
- $n$ - это объём выборки
- $k_{UR}$ - это количество параметров модели без ограничений

_Тест множителей Лагранжа_

\[
LM=nR^2_{step2} \sim \chi^2_{n-1}
\]

где

- $R$ - коэффициент детерминации 
- $n$ - количество ограниченй

_Тест Голдфельда-Квандта (Goldfeld-Quandt)_

\[
\begin{cases}
H_0:Var(u_i|x_i)=\sigma^2\\
H_a:Var(u_i|x_i)=f(x_i) \\
\end{cases}
\]

Далее наблюдения сортируются по подозреваемому росту (по дисперсии). Из сортированной выборки выкидываются наблюдения с средней дисперсией (как правило, избавляются примерно от 20%). Далее берётся F-статистика.

Выходит примерно следующая картина:

```{r, "grafic", echo=FALSE, results='hide',message=FALSE}
gdf2 <- h[h$totsp < 85, ]
gdf3 <- h[h$totsp > 95, ]
gdf1 <- rbind(gdf2, gdf3)
gg <- ggplot(gdf1, aes(totsp, price))
gg + geom_point(alpha = 0.5) + geom_vline(xintercept = c(85,95), color = "red") + xlab("Общая площадь") + ylab("Цена квартиры") 
```


\[
F=\frac{RSS2/(n_2-k)}{RSS_1/(n_1-k)} \sim F(n_2-k, n_1-k)
\]

где

- $RSS_1$ - сумма квадратов остатков части выборки с низкой дисперсией
- $RSS_2$ - сумма квадратов остатков части выборки с высокой дисперсией
- $n_1$ - количество наблюдений с низкой дисперсией
- $n_2$ - количество наблюдений с высокой дисперсией 
- $k$ - количество ограничений

__Примечание:__ если $n_1=n_2$, тогда статистика равна:

\[
F=\frac{RSS_2}{RSS_1}
\]

Если __F__ большое $\Rightarrow H_0$ отвергается (т.е. наблюдается гетероскедастичность). 

### Так делать нехорошо:

1. Протестировать наличие гетероскедастичности 

2. Если гипотеза о гомоскедаксичности отвергнута, использовать робастные стандартные ошибки($se_{hco} (\widehat{\beta}_i)$)

3. Если гипотеза о гомоскедастичности отвергнута, использовать обычные стандартные ошибки ($se(\widehat{\beta}_i)$)

### Примечание

Как делают нормальные люди:

_RSS_ - Residiual Sum of sq = $\widehat{u}^2_i$

_ESS_ - Explained Sum of sq = $\sum (\widehat{y}^2_i-\bar{y}_i)^2$

Как делают гопники:

_ESS_ - Error Sum of sq = $\widehat{u}^2_i$ 

_RSS_ - Regression Sum of sq = $\sum (\widehat{y}^2_i-\bar{y}_i)^2$

### Пакеты для __R__:
- tidyvers
- lmtest
- memisc
- sandwich

### Немного __R__


```{r setup, include=FALSE }
library(tidyverse)
library(lmtest)
library(memisc)
library(sandwich)
```

```{r cars}
glimpse(diamonds)
```


Посмотрим на график зависимости цены и карата бриллианта
```{r plot1}
qplot(data = diamonds, x = carat, y = price)
```
Видна гетероскедастичность
Поробуем прологарифмировать.
```{r plot2}
qplot(data = diamonds, x = log(carat), y = log(price))
```
Гетероскедастичность осталась.

Построим модель регрессии, где карат - объясняющая переменнаяб цена - зависимая переменная.
```{r model}
model <- lm(data = diamonds,
            log(price) ~ log(carat))
coeftest(model)
```

```{r coeftest}
coeftest(model, vcov. = vcovHC)
```
тест Breush-Pagan (White)

```{r bptest}
bptest(model, varformula = ~ log(table) + log(carat), data = diamonds)
```
тест Goldfeld-Quandt

Чтобы отловить какая величина виновата в гетероскедастичности

```{r gqtest1}
gqtest(model, fraction = 0.2, order.by = diamonds$table)
```

```{r gqtest2}
gqtest(model, fraction = 0.2, order.by = diamonds$carat)
```


### Полезные ссылочки

Ссылки на одну свободную энциклопедию:

- Собственно гетероскедастичность [Википедия](https://ru.wikipedia.org/wiki/%D0%93%D0%B5%D1%82%D0%B5%D1%80%D0%BE%D1%81%D0%BA%D0%B5%D0%B4%D0%B0%D1%81%D1%82%D0%B8%D1%87%D0%BD%D0%BE%D1%81%D1%82%D1%8C)

- F-тест [Википедия](https://en.wikipedia.org/wiki/F-test)

- Тест множителей Лагранжа [Википедия](https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82_%D0%BC%D0%BD%D0%BE%D0%B6%D0%B8%D1%82%D0%B5%D0%BB%D0%B5%D0%B9_%D0%9B%D0%B0%D0%B3%D1%80%D0%B0%D0%BD%D0%B6%D0%B0)

- Тест Бройша — Пагана [Википедия](https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82_%D0%91%D1%80%D0%BE%D0%B9%D1%88%D0%B0_%E2%80%94_%D0%9F%D0%B0%D0%B3%D0%B0%D0%BD%D0%B0)

- Тест Голдфелда — Куандта [Википедия](https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82_%D0%93%D0%BE%D0%BB%D0%B4%D1%84%D0%B5%D0%BB%D0%B4%D0%B0_%E2%80%94_%D0%9A%D1%83%D0%B0%D0%BD%D0%B4%D1%82%D0%B0)

Прочие ссылки:

- Компьютерная гетероскедастичность от занимательного исследователя [Гетероскедастичность в R](https://rpubs.com/boris_demeshev/r_cycle_12)
- Еще один рример определения гетероскедастичности в R [R-bloggers](https://www.r-bloggers.com/how-to-detect-heteroscedasticity-and-rectify-it/)
